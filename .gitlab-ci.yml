# VisionForge Pro - GitLab CI/CD é…ç½®
# è‡ªåŠ¨åŒ–æµ‹è¯•ã€ä»£ç è¦†ç›–ç‡ã€æ€§èƒ½åŸºå‡†æµ‹è¯•

stages:
  - build
  - test
  - coverage
  - deploy

variables:
  BUILD_TYPE: "Release"
  GIT_SUBMODULE_STRATEGY: recursive

# ==================== ç¼“å­˜é…ç½® ====================
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - build/
    - vcpkg/
    - .cache/

# ==================== Windowsæ„å»º ====================
build:windows:
  stage: build
  tags:
    - windows
    - msvc
  script:
    - echo "ğŸ—ï¸ é…ç½®Windowsæ„å»ºç¯å¢ƒ"
    - cmake -B build -DCMAKE_BUILD_TYPE=%BUILD_TYPE% -DUSE_GTEST=ON
    - echo "ğŸ”¨ ç¼–è¯‘é¡¹ç›®"
    - cmake --build build --config %BUILD_TYPE% -j 4
  artifacts:
    paths:
      - build/bin/%BUILD_TYPE%/*.exe
      - build/lib/%BUILD_TYPE%/*.lib
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_requests

# ==================== Linuxæ„å»º ====================
build:linux:
  stage: build
  image: ubuntu:22.04
  tags:
    - docker
  before_script:
    - apt-get update
    - apt-get install -y build-essential cmake ninja-build qt6-base-dev libopencv-dev
  script:
    - echo "ğŸ—ï¸ é…ç½®Linuxæ„å»ºç¯å¢ƒ"
    - cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug -DUSE_GTEST=ON -DENABLE_COVERAGE=ON
    - echo "ğŸ”¨ ç¼–è¯‘é¡¹ç›®"
    - cmake --build build -j $(nproc)
  artifacts:
    paths:
      - build/bin/test_*_gtest
      - build/lib/*.a
    expire_in: 1 day
  only:
    - master
    - develop
    - merge_requests

# ==================== Windowsæµ‹è¯• ====================
test:windows:
  stage: test
  tags:
    - windows
  dependencies:
    - build:windows
  script:
    - echo "ğŸ§ª è¿è¡ŒWindowsæµ‹è¯•å¥—ä»¶"
    - cd build\bin\%BUILD_TYPE%
    - test_ImageData_gtest.exe --gtest_output=xml:test_results_imagedata.xml
    - test_BasicImageProcessing_gtest.exe --gtest_output=xml:test_results_basic.xml
    - test_EdgeAndMorphology_gtest.exe --gtest_output=xml:test_results_edge.xml
    - test_ShapeDetection_gtest.exe --gtest_output=xml:test_results_shape.xml
    - test_Measurement_gtest.exe --gtest_output=xml:test_results_measure.xml
  artifacts:
    reports:
      junit: build/bin/%BUILD_TYPE%/test_results_*.xml
    paths:
      - build/bin/%BUILD_TYPE%/test_results_*.xml
    expire_in: 30 days
  only:
    - master
    - develop
    - merge_requests

# ==================== Linuxæµ‹è¯• + ä»£ç è¦†ç›–ç‡ ====================
test:linux:
  stage: test
  image: ubuntu:22.04
  tags:
    - docker
  dependencies:
    - build:linux
  before_script:
    - apt-get update
    - apt-get install -y libqt6core6 libqt6widgets6 libopencv-core4.5d libopencv-imgproc4.5d
  script:
    - echo "ğŸ§ª è¿è¡ŒLinuxæµ‹è¯•å¥—ä»¶"
    - cd build/bin
    - for test in test_*_gtest; do
        echo "=== è¿è¡Œ $test ===";
        ./$test --gtest_output=xml:${test}_results.xml;
      done
  artifacts:
    reports:
      junit: build/bin/*_results.xml
    paths:
      - build/bin/*_results.xml
    expire_in: 30 days
  coverage: '/lines......: \d+\.\d+%/'
  only:
    - master
    - develop
    - merge_requests

# ==================== ä»£ç è¦†ç›–ç‡æŠ¥å‘Š ====================
coverage:report:
  stage: coverage
  image: ubuntu:22.04
  tags:
    - docker
  dependencies:
    - build:linux
    - test:linux
  before_script:
    - apt-get update
    - apt-get install -y lcov gcovr
  script:
    - echo "ğŸ“Š ç”Ÿæˆä»£ç è¦†ç›–ç‡æŠ¥å‘Š"
    - lcov --capture --directory build --output-file coverage.info
    - lcov --remove coverage.info '/usr/*' '*/test/*' '*/build/*' --output-file coverage_filtered.info
    - lcov --list coverage_filtered.info
    - genhtml coverage_filtered.info --output-directory coverage_html
    - gcovr --xml-pretty --exclude-unreachable-branches --print-summary -o coverage.xml --root ${CI_PROJECT_DIR}
  artifacts:
    paths:
      - coverage_html/
      - coverage.xml
      - coverage_filtered.info
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 30 days
  coverage: '/lines......: \d+\.\d+%/'
  only:
    - master
    - develop
    - merge_requests

# ==================== æ€§èƒ½åŸºå‡†æµ‹è¯• ====================
benchmark:performance:
  stage: test
  image: ubuntu:22.04
  tags:
    - docker
    - performance
  dependencies:
    - build:linux
  script:
    - echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
    - cd build/bin
    - for test in test_*_gtest; do
        echo "=== è¿è¡Œ $test æ€§èƒ½æµ‹è¯• ===";
        ./$test --gtest_also_run_disabled_tests --gtest_filter="*DISABLED_Performance*" || true;
      done
  allow_failure: true
  only:
    - merge_requests
    - master

# ==================== æµ‹è¯•æŠ¥å‘Šéƒ¨ç½²åˆ°Pages ====================
pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - coverage:report
  script:
    - echo "ğŸ“¤ éƒ¨ç½²è¦†ç›–ç‡æŠ¥å‘Šåˆ°GitLab Pages"
    - mkdir -p public
    - cp -r coverage_html/* public/
    - echo "<html><body><h1>VisionForge Pro ä»£ç è¦†ç›–ç‡æŠ¥å‘Š</h1><a href='index.html'>æŸ¥çœ‹æŠ¥å‘Š</a></body></html>" > public/index.html
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - master

# ==================== æ¯æ—¥å®šæ—¶æµ‹è¯• ====================
scheduled:nightly:
  stage: test
  extends: test:linux
  script:
    - echo "ğŸŒ™ æ¯æ—¥å¤œé—´å®Œæ•´æµ‹è¯•"
    - cd build/bin
    - for test in test_*_gtest; do
        echo "=== è¿è¡Œ $test (å«æ€§èƒ½æµ‹è¯•) ===";
        ./$test --gtest_also_run_disabled_tests;
      done
  only:
    - schedules
  allow_failure: false

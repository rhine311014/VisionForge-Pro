# VisionForge Pro - 整体架构设计文档

## 文档信息

- **项目名称**: VisionForge Pro
- **文档版本**: v1.0
- **创建日期**: 2025-12-14
- **最后更新**: 2025-12-14
- **设计者**: VisionForge Team

---

## 1. 项目概述

### 1.1 项目目标

VisionForge Pro 是一款通用工业视觉检测平台，目标是：

- **极致易用性**: 5分钟快速上手（类Keyence体验）
- **算法先进性**: 集成最新AI技术 + 传统CV算法
- **性能极限**: 典型场景 <10ms，简单场景 <3ms
- **开放生态**: 支持二次开发和插件扩展

### 1.2 核心设计理念

```
设计哲学：
┌─────────────────────────────────────────────────────┐
│  "简单的事情简单做，复杂的事情也能做"                │
│                                                     │
│  新手模式：向导式，隐藏复杂性                        │
│     ↕                                               │
│  专家模式：完整功能，深度定制                        │
└─────────────────────────────────────────────────────┘
```

---

## 2. 六层架构设计

### 2.1 架构总览

```
┌──────────────────────────────────────────────────────────────┐
│                    应用层 (Presentation)                      │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 简单模式UI          专业模式UI         配置向导         │  │
│  │ (SimpleMode)       (ProMode)          (Wizard)         │  │
│  └────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│                   业务逻辑层 (Business)                       │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 配方管理    任务调度    结果判定    故障诊断   权限管理  │  │
│  │ (Recipe)   (Schedule)  (Judge)     (Diag)     (Auth)   │  │
│  └────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│                   算法服务层 (Algorithm)                      │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 传统CV服务   AI推理服务   流程执行引擎   性能监控       │  │
│  │ (CVService) (AIService)   (Pipeline)    (Monitor)      │  │
│  └────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│                  设备抽象层 (HAL - Hardware)                  │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ ICamera      ILight      IPLC       IMotion            │  │
│  │ (相机接口)   (光源接口)  (PLC接口)  (运动控制)          │  │
│  └────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│                 基础设施层 (Infrastructure)                   │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 内存池     日志系统    配置管理    线程池    通信框架   │  │
│  │ (MemPool) (Logger)    (Config)   (Thread)  (Comm)     │  │
│  └────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────┤
│                  数据持久层 (Persistence)                     │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ 配方数据库   审计日志    图像存储    统计数据           │  │
│  │ (RecipeDB) (AuditLog)  (ImageStore) (Statistics)      │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 层级职责定义

| 层级 | 职责 | 技术栈 |
|------|------|--------|
| **应用层** | UI交互、用户体验、界面渲染 | Qt 6.5 Widgets + QGraphicsView |
| **业务逻辑层** | 配方管理、任务编排、业务规则 | C++ 标准库 + Qt Core |
| **算法服务层** | 图像处理、AI推理、算法执行 | OpenCV 4.x + ONNX Runtime + TensorRT |
| **设备抽象层** | 硬件接口、驱动封装、模拟设备 | GenICam + 厂商SDK |
| **基础设施层** | 通用组件、系统服务、工具库 | Qt Core + Boost (可选) |
| **数据持久层** | 数据存储、日志记录、配置持久化 | SQLite + JSON + Protocol Buffers |

---

## 3. 核心模块设计

### 3.1 双模式UI架构

```
┌─────────────────────────────────────────────────────────────┐
│              MainWindow (主窗口控制器)                       │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  模式选择器: [简单模式 ▼]                              │  │
│  └───────────────────────────────────────────────────────┘  │
│                         │                                    │
│         ┌───────────────┴───────────────┐                   │
│         │                               │                   │
│    ┌────▼────────┐               ┌──────▼─────────┐         │
│    │ SimpleMode  │               │  ProfessionalMode│        │
│    │  Widget     │               │     Widget      │        │
│    └─────────────┘               └────────────────┘         │
│         │                               │                   │
│         │  共享组件                      │                   │
│         ├──────────────┬────────────────┤                   │
│         │              │                │                   │
│    ┌────▼────┐   ┌─────▼─────┐   ┌─────▼─────┐             │
│    │ImageView│   │StepList   │   │ParamPanel │             │
│    │图像显示  │   │步骤列表   │   │参数面板   │             │
│    └─────────┘   └───────────┘   └───────────┘             │
└─────────────────────────────────────────────────────────────┘
```

#### 3.1.1 简单模式 (SimpleMode)

**设计目标**: 5分钟上手，隐藏复杂性

**核心组件**:
- **StepListWidget**: 左侧步骤列表（单列、大图标）
- **ImageDisplayWidget**: 中间图像显示（大画面）
- **SimpleParamPanel**: 右侧简化参数面板（仅核心参数）
- **QuickToolSelector**: 工具选择器（图标式对话框）

**布局方式**:
```
┌───────────┬──────────────────┬───────────┐
│  步骤列表  │   图像显示区      │ 参数面板   │
│  (15%)    │     (55%)        │  (30%)    │
└───────────┴──────────────────┴───────────┘
```

#### 3.1.2 专业模式 (ProfessionalMode)

**设计目标**: 完整功能，深度定制

**核心组件**:
- **ProjectTreeWidget**: 左上项目树（多任务管理）
- **ToolboxWidget**: 左下工具箱（可拖拽）
- **TabbedWorkspace**: 中间多Tab工作区（图像/流程/数据/日志）
- **PropertyPanel**: 右侧完整属性面板（分组、可折叠）
- **StepNavigator**: 底部步骤导航条（快速跳转）

**布局方式**:
```
┌──────────┬────────────────────────────┬──────────┐
│ 项目树   │    工作区 (多Tab切换)       │  属性面板 │
│  (15%)   │  [图像|流程|数据|日志]      │  (25%)   │
│──────────│            (60%)           │          │
│ 工具箱   │                            │          │
│          │                            │          │
└──────────┴────────────────────────────┴──────────┘
```

### 3.2 模式切换机制

```cpp
// 伪代码
class ModeManager {
public:
    enum Mode { Simple, Professional };

    void switchMode(Mode mode) {
        // 1. 保存当前模式状态
        saveCurrentState();

        // 2. 切换UI布局
        if (mode == Simple) {
            showSimpleMode();
            hideAdvancedFeatures();
        } else {
            showProfessionalMode();
            showAdvancedFeatures();
        }

        // 3. 恢复数据（配方、步骤等保持一致）
        restoreData();
    }

private:
    // 核心数据层不变，只是UI表现形式不同
    SharedDataModel* dataModel;
};
```

---

## 4. 数据流架构

### 4.1 图像处理管道

```
┌────────┐     ┌────────┐     ┌────────┐     ┌────────┐
│ 相机   │────>│ 内存池 │────>│ 算法   │────>│ 结果   │
│ 采集   │     │ 缓冲   │     │ 处理   │     │ 输出   │
└────────┘     └────────┘     └────────┘     └────────┘
    │              │              │              │
    └──────────────┴──────────────┴──────────────┘
                   │
              性能监控 (每步耗时统计)
```

### 4.2 零拷贝机制

```cpp
// 图像数据在整个管道中使用共享指针，避免拷贝
class ImageData {
public:
    using Ptr = std::shared_ptr<ImageData>;

    cv::Mat mat;              // OpenCV矩阵（浅拷贝）
    void* devicePtr;          // GPU内存指针
    size_t timestamp;         // 时间戳

    // 禁止拷贝构造
    ImageData(const ImageData&) = delete;
    ImageData& operator=(const ImageData&) = delete;
};

// 步骤间传递使用智能指针
ImageData::Ptr image = std::make_shared<ImageData>();
step1->process(image);  // 输入
step2->process(image);  // 同一块内存，零拷贝
```

---

## 5. 配方（Recipe）架构

### 5.1 配方数据模型

```
Recipe (配方)
  ├─ Metadata (元数据)
  │   ├─ name: string
  │   ├─ version: int
  │   ├─ createdTime: timestamp
  │   ├─ modifiedTime: timestamp
  │   └─ author: string
  │
  ├─ CameraConfig (相机配置)
  │   ├─ deviceName: string
  │   ├─ resolution: Size
  │   ├─ exposure: double
  │   ├─ gain: double
  │   └─ triggerMode: enum
  │
  ├─ StepList (步骤列表)
  │   └─ Step[] (步骤数组)
  │       ├─ id: UUID
  │       ├─ type: enum (Gray/Blur/FindCircle...)
  │       ├─ enabled: bool
  │       ├─ params: JSON (步骤参数)
  │       └─ connections: {inputFrom, outputTo}
  │
  └─ JudgmentRules (判定规则)
      ├─ okCondition: Expression
      ├─ ngCondition: Expression
      └─ outputMapping: {OK→DO1, NG→DO2}
```

### 5.2 配方版本控制

```
RecipeVersionControl
  ├─ currentVersion: int
  ├─ versionHistory[]
  │   ├─ version: int
  │   ├─ timestamp: datetime
  │   ├─ author: string
  │   ├─ changeLog: string
  │   └─ recipeSnapshot: Recipe
  │
  ├─ diff(v1, v2) → Changes[]
  ├─ rollback(targetVersion)
  └─ export() → .vfproj 文件
```

---

## 6. 算法工具（Tool）架构

### 6.1 工具基类设计

```cpp
// 所有算法工具的抽象基类
class VisionTool : public QObject {
    Q_OBJECT

public:
    virtual ~VisionTool() = default;

    // 核心接口
    virtual bool process(const ImageData::Ptr& input,
                        ToolResult& output) = 0;

    virtual QString getToolName() const = 0;
    virtual QIcon getToolIcon() const = 0;
    virtual QWidget* getParamWidget() = 0;

    // 参数序列化
    virtual QJsonObject serializeParams() const = 0;
    virtual void deserializeParams(const QJsonObject& json) = 0;

    // 调试支持
    virtual ImageData::Ptr getDebugImage() const = 0;
    virtual QString getStatusText() const = 0;

signals:
    void paramChanged();
    void processingFinished(bool success);
    void debugImageUpdated();
};
```

### 6.2 工具分类

| 类别 | 工具示例 | 实现类 |
|------|---------|--------|
| **图像源** | 相机、文件、视频 | CameraTool, FileTool |
| **预处理** | 灰度、滤波、ROI | GrayTool, BlurTool, ROITool |
| **定位** | 模板匹配、找圆、边缘 | MatchTool, FindCircleTool |
| **AI检测** | YOLO、分类、分割 | YOLOTool, ClassifyTool |
| **测量** | 距离、角度、面积 | MeasureTool, CalcTool |
| **判定** | 范围判定、逻辑运算 | JudgeTool, LogicTool |
| **输出** | PLC通信、保存图像 | PLCTool, SaveTool |

---

## 7. 性能优化策略

### 7.1 内存管理

```cpp
// 预分配内存池（避免运行时malloc）
class ImageMemoryPool {
public:
    static ImageMemoryPool& instance();

    ImageData::Ptr allocate(const cv::Size& size, int type) {
        // 从池中分配或复用已有内存
        return pool_.get(size, type);
    }

    void release(ImageData::Ptr image) {
        // 归还池中，不真正释放
        pool_.put(image);
    }

private:
    MemoryPool pool_;
};
```

### 7.2 多线程流水线

```
线程模型：
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ 线程1    │    │ 线程2    │    │ 线程3    │    │ 线程4    │
│ 图像采集 │───>│ 预处理   │───>│ 算法检测 │───>│ 结果输出 │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │               │               │
     └───────────────┴───────────────┴───────────────┘
                      │
                 无锁队列通信
```

### 7.3 GPU加速策略

| 场景 | CPU实现 | GPU加速 | 性能提升 |
|------|---------|---------|---------|
| 图像滤波 | OpenCV CPU | CUDA滤波核 | 5-10x |
| AI推理 | ONNX Runtime CPU | TensorRT GPU | 10-50x |
| 几何变换 | OpenCV | OpenCL/CUDA | 3-8x |

---

## 8. 扩展性设计

### 8.1 插件系统架构（Phase 2）

```
PluginManager
  ├─ loadPlugin(path) → IVisionPlugin*
  ├─ unloadPlugin(pluginId)
  ├─ listPlugins() → PluginInfo[]
  └─ validatePlugin(plugin) → bool (安全检查)

IVisionPlugin 接口
  ├─ getPluginInfo() → {name, version, author}
  ├─ initialize(context)
  ├─ createTool() → VisionTool*
  └─ cleanup()
```

### 8.2 二次开发SDK

提供的API层级：
1. **Level 1**: 使用现有工具组合（配置文件）
2. **Level 2**: 编写自定义工具（继承VisionTool）
3. **Level 3**: 深度集成（访问底层HAL）

---

## 9. 非功能性需求

### 9.1 性能指标

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| 界面响应时间 | <50ms | 点击到显示的延迟 |
| 图像显示帧率 | >30 FPS | 连续采集显示流畅度 |
| 典型检测耗时 | <10ms | 8-10个步骤的完整流程 |
| 简单检测耗时 | <3ms | 2-3个步骤的基础检测 |
| 配方加载时间 | <1s | 从文件加载到可运行 |
| 内存占用 | <500MB | 空载 + 1个任务运行 |

### 9.2 稳定性指标

| 指标 | 目标值 |
|------|--------|
| 连续运行时长 | >72小时不崩溃 |
| 内存泄漏率 | <1MB/小时 |
| 崩溃率 | <0.01% (每10,000次操作) |

### 9.3 兼容性

| 维度 | 支持范围 |
|------|---------|
| 操作系统 | Windows 10/11 LTSC, Ubuntu 20.04+ |
| 分辨率 | 1366x768 ~ 4K (自适应缩放) |
| 相机接口 | GenICam (GigE/USB3) |
| CPU架构 | x64 (Phase 1), ARM64 (Phase 2) |

---

## 10. 安全与合规

### 10.1 用户权限系统

```
UserRole
  ├─ Operator (操作员)
  │   ├─ 运行配方
  │   ├─ 查看结果
  │   └─ ✗ 不能修改配方
  │
  ├─ Engineer (工程师)
  │   ├─ 修改配方
  │   ├─ 创建新任务
  │   └─ 查看日志
  │
  └─ Administrator (管理员)
      ├─ 用户管理
      ├─ 系统配置
      └─ 审计日志查看
```

### 10.2 审计日志

记录内容：
- 用户登录/登出
- 配方修改（修改前后对比）
- 系统参数变更
- 关键错误事件

格式：符合 ISO 8601 时间戳 + JSON结构化数据

---

## 11. 开发路线图

### Phase 1: MVP (9个月)

| 月份 | 里程碑 | 交付物 |
|------|--------|--------|
| M1-M3 | 技术验证 | 基础框架 + HAL + 单相机Demo |
| M4-M6 | Alpha版 | 简单模式 + 8-10个工具 + 业务逻辑层 |
| M7-M9 | Beta版 | 专业模式 + 故障诊断 + 1个行业模板 |

### Phase 2: 增强版 (+6个月)

- 多相机同步
- AI模型集成（TensorRT）
- 3个行业模板
- 高级统计分析

### Phase 3: 生态版 (+6个月)

- 插件SDK
- 插件市场
- 云端协同
- 移动端监控

---

## 12. 风险评估

| 风险 | 等级 | 缓解措施 |
|------|------|---------|
| Qt 6性能问题 | 中 | 提前性能测试，必要时降级Qt 5 |
| GenICam覆盖不足 | 中 | 预留私有驱动接口 |
| AI推理性能不达标 | 高 | 早期验证TensorRT，准备降级方案 |
| 团队规模不足 | 高 | 精简MVP范围，聚焦核心功能 |
| 第三方库许可证 | 中 | 法务审查，避免GPL污染 |

---

## 13. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 配方 | Recipe | 完整的检测任务配置（相机+步骤+判定） |
| 步骤 | Step | 单个图像处理工具的实例 |
| 工具 | Tool | 算法功能的抽象（如找圆、测距） |
| HAL | Hardware Abstraction Layer | 硬件抽象层 |
| ROI | Region of Interest | 感兴趣区域 |
| PLC | Programmable Logic Controller | 可编程逻辑控制器 |
| GenICam | Generic Interface for Cameras | 通用相机接口标准 |

---

## 14. 参考资料

- Qt 6 Documentation: https://doc.qt.io/qt-6/
- OpenCV 4 Documentation: https://docs.opencv.org/4.x/
- ONNX Runtime: https://onnxruntime.ai/docs/
- GenICam Standard: https://www.emva.org/standards-technology/genicam/

---

**文档状态**: ✅ 已完成
**审核状态**: 待审核
**下一步**: 编写详细类图设计

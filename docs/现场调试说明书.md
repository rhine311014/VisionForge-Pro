# VisionForge Pro 现场调试说明书

**版本**: 1.2.0
**日期**: 2025年12月
**文档编号**: VF-DEBUG-001

---

## 目录

1. [系统概述](#1-系统概述)
2. [系统架构](#2-系统架构)
3. [硬件连接指南](#3-硬件连接指南)
4. [软件安装与配置](#4-软件安装与配置)
5. [相机调试流程](#5-相机调试流程)
6. [通信协议配置](#6-通信协议配置)
7. [算法工具链使用](#7-算法工具链使用)
8. [标定流程](#8-标定流程)
9. [故障排查指南](#9-故障排查指南)
10. [常见问题与解决方案](#10-常见问题与解决方案)
11. [附录](#附录)

---

## 1. 系统概述

### 1.1 产品简介

VisionForge Pro 是一款面向工业现场的通用视觉检测平台，提供极致易用性、先进AI算法和极致性能表现。

### 1.2 核心特性

| 特性 | 说明 |
|------|------|
| 极致易用性 | 5分钟快速上手，双模式UI设计 |
| 算法先进性 | 集成AI深度学习 + 传统CV算法 |
| 性能极限 | 典型场景 <10ms，简单场景 <3ms |
| 开放生态 | 支持插件扩展和二次开发 |

### 1.3 支持的硬件

- **工业相机**: GenICam (GigE/USB3)、海康威视、Basler
- **光源控制**: 串口/网口光源控制器
- **PLC通信**: Modbus TCP/RTU, OPC UA, EtherCAT, 三菱MC协议, 基恩士PC-Link
- **运动控制**: 模拟控制器（实际控制器待支持）

### 1.4 软件要求

| 组件 | 版本要求 | 推荐安装路径 |
|------|----------|--------------|
| Windows | 10/11 64位 | - |
| Visual Studio | 2022 | F:\Program Files\Microsoft Visual Studio\2022 |
| Qt | 6.9.3 | F:\Qt\6.9.3 |
| OpenCV | 4.8+ (CUDA版本) | F:\Program Files\OPENCV |
| Halcon | 24.11 (可选) | F:\Halcon\HALCON-24.11-Progress-Steady |

---

## 2. 系统架构

### 2.1 整体架构图

```
+=========================================================================+
|                           VisionForge Pro 系统架构                        |
+=========================================================================+
|                                                                          |
|  +---------------------------+  +---------------------------+            |
|  |       简单模式 UI         |  |       专业模式 UI         |            |
|  | - 步骤列表式界面          |  | - 完整三栏布局            |            |
|  | - 核心参数滑块调整        |  | - 项目树管理              |            |
|  | - ROI鼠标示教             |  | - 高级参数配置            |            |
|  | - 实时预览效果            |  | - 单步调试功能            |            |
|  +---------------------------+  +---------------------------+            |
|                              |                                           |
|  +---------------------------------------------------------------+      |
|  |                        UI 层 (Qt 6.9)                         |      |
|  |  MainWindow | ImageViewer | ToolDialogs | ConfigDialogs       |      |
|  +---------------------------------------------------------------+      |
|                              |                                           |
|  +---------------------------------------------------------------+      |
|  |                      核心业务层 (Core)                         |      |
|  |  VisionProject | ToolChain | Recipe | TaskScheduler           |      |
|  +---------------------------------------------------------------+      |
|                              |                                           |
|  +---------------------------------------------------------------+      |
|  |                      算法服务层 (Algorithm)                    |      |
|  |  +----------------+  +----------------+  +----------------+    |      |
|  |  | 图像预处理     |  | 特征检测       |  | 测量分析       |    |      |
|  |  | Gray/Blur/     |  | Edge/Circle/   |  | Distance/      |    |      |
|  |  | Threshold      |  | Line/Blob      |  | Angle/Area     |    |      |
|  |  +----------------+  +----------------+  +----------------+    |      |
|  |  +----------------+  +----------------+  +----------------+    |      |
|  |  | 模板匹配       |  | AI深度学习     |  | 标定工具       |    |      |
|  |  | Shape/Template |  | YOLO/分类/分割 |  | 九点/相机标定  |    |      |
|  |  +----------------+  +----------------+  +----------------+    |      |
|  +---------------------------------------------------------------+      |
|                              |                                           |
|  +---------------------------+---------------------------+               |
|  |        HAL 硬件抽象层      |        通信层 (Comm)       |               |
|  |  +-------------------+     |  +-------------------+     |               |
|  |  | CameraManager     |     |  | PLCManager        |     |               |
|  |  | - GenTLCamera     |     |  | - ModbusTCP/RTU   |     |               |
|  |  | - HikvisionCamera |     |  | - OPC UA Client   |     |               |
|  |  | - BaslerCamera    |     |  | - MitsubishiMC    |     |               |
|  |  | - SimulatedCamera |     |  | - KeyencePCLink   |     |               |
|  |  +-------------------+     |  +-------------------+     |               |
|  |  | GPIOController    |     |  | LightController   |     |               |
|  |  | MotionController  |     |  +-------------------+     |               |
|  +---------------------------+---------------------------+               |
|                              |                                           |
|  +---------------------------------------------------------------+      |
|  |                      基础设施层 (Base)                         |      |
|  |  Logger | ConfigManager | PluginManager | PerformanceMonitor  |      |
|  |  ImageMemoryPool | GPUAccelerator | CrashHandler | OTAUpdater |      |
|  +---------------------------------------------------------------+      |
|                                                                          |
+==========================================================================+
```

### 2.2 模块功能说明

| 模块 | 路径 | 功能说明 |
|------|------|----------|
| UI层 | src/ui/ | 用户界面，包含主窗口、图像显示、工具对话框等 |
| Core层 | src/core/ | 核心业务逻辑，项目管理、工具链、配方管理 |
| Algorithm层 | src/algorithm/ | 算法实现，图像处理、检测、测量、AI推理 |
| HAL层 | src/hal/ | 硬件抽象，相机驱动、GPIO控制、运动控制 |
| Comm层 | src/comm/ | 通信协议，PLC通信、光源控制 |
| Base层 | src/base/ | 基础设施，日志、配置、内存池、性能监控 |
| Calibration层 | src/calibration/ | 标定模块，QR码标定、对齐引擎 |

---

## 3. 硬件连接指南

### 3.1 相机连接

#### 3.1.1 GigE相机连接

```
+================+                    +================+
|   工控机       |                    |   GigE相机     |
|                |                    |                |
|   [网口1] -----+---- 千兆网线 ------+---- [网口]     |
|                |                    |                |
+================+                    +================+
```

**网络配置要求**:

| 配置项 | 建议值 | 说明 |
|--------|--------|------|
| IP地址 | 192.168.1.x | 与相机同网段 |
| 子网掩码 | 255.255.255.0 | 标准C类网络 |
| MTU | 9000 | 启用巨型帧提升传输效率 |
| 接收缓冲区 | 16MB+ | 防止丢包 |

**网卡配置步骤**:

1. 打开"网络适配器属性"
2. 选择"配置" -> "高级"
3. 设置"Jumbo Packet"为9014字节
4. 设置"接收缓冲区"为最大值
5. 禁用"节能模式"

#### 3.1.2 USB3相机连接

```
+================+                    +================+
|   工控机       |                    |   USB3相机     |
|                |                    |                |
|   [USB3.0] ----+---- USB3线缆 ------+---- [USB3]     |
|                |    (< 3米)         |                |
+================+                    +================+
```

**注意事项**:
- 使用原装USB3.0线缆
- 线缆长度不超过3米
- 使用USB3.0扩展卡时确保供电充足

### 3.2 PLC连接

#### 3.2.1 Modbus TCP连接

```
+================+                    +================+
|   工控机       |                    |   PLC          |
|                |                    |                |
|   [网口2] -----+---- 网线 ----------+---- [以太网口] |
|                |                    |                |
+================+                    +================+

网络配置:
- 工控机IP: 192.168.0.100
- PLC IP: 192.168.0.1
- 端口: 502 (Modbus标准端口)
```

#### 3.2.2 Modbus RTU连接

```
+================+                    +================+
|   工控机       |                    |   PLC          |
|                |                    |                |
|   [COM1] ------+---- RS485线 -------+---- [RS485]    |
|   (RS485转接)  |                    |                |
+================+                    +================+

串口配置:
- 波特率: 9600/19200/38400/115200
- 数据位: 8
- 停止位: 1
- 校验: None/Even/Odd
```

#### 3.2.3 OPC UA连接

```
+================+                    +================+
|   工控机       |     网络           |   OPC UA服务器 |
|  (OPC UA客户端)|                    |                |
|   [网口] ------+--------------------+---- [网口]     |
|                |                    |                |
+================+                    +================+

连接URL: opc.tcp://192.168.1.100:4840
```

### 3.3 光源连接

```
+================+     +================+     +================+
|   工控机       |     |   光源控制器   |     |   光源         |
|                |     |                |     |                |
|   [COM2] ------+-----+---- [RS232]    |     |                |
|   或 [网口]    |     |   [触发输出] --+-----+---- [触发输入] |
|                |     |                |     |                |
+================+     +================+     +================+
```

### 3.4 系统接线总图

```
                           +=====================+
                           |      工控机主机      |
                           |                     |
                           |  +---------------+  |
                           |  |  VisionForge  |  |
                           |  |     Pro       |  |
                           |  +---------------+  |
                           |                     |
        +------------------+-- [网口1: GigE相机] |
        |                  |                     |
        |  +---------------+-- [网口2: PLC通信]  |
        |  |               |                     |
        |  |  +------------+-- [USB3: USB相机]   |
        |  |  |            |                     |
        |  |  |  +---------+-- [COM1: RS485/PLC] |
        |  |  |  |         |                     |
        |  |  |  |  +------+-- [COM2: 光源控制]  |
        |  |  |  |  |      |                     |
        |  |  |  |  |  +---+-- [GPIO: 数字IO]    |
        |  |  |  |  |  |   |                     |
        +==|==|==|==|==|===+=====================+
           |  |  |  |  |
           v  v  v  v  v
        +--+--+--+--+--+--+
        |  GigE  |  USB3 |
        | 相机1-4 | 相机  |
        +---------+-------+
              |
              v
        +-----+-----+       +-------------+
        |   PLC     | <---> | 光源控制器  |
        | (主站)    |       +-------------+
        +-----------+             |
              |                   v
              v             +-----+-----+
        +-----+-----+       |   光源    |
        | 传感器/   |       | (环形/条形)|
        | 执行器    |       +-----------+
        +-----------+
```

---

## 4. 软件安装与配置

### 4.1 安装前准备

**系统检查清单**:

- [ ] Windows 10/11 64位系统
- [ ] 至少16GB内存
- [ ] 500GB+ SSD硬盘
- [ ] 独立显卡 (推荐NVIDIA GTX 1060+)
- [ ] 千兆网卡
- [ ] USB3.0接口

### 4.2 安装步骤

#### 步骤1: 安装运行时环境

```
1. 安装 Visual C++ Redistributable 2022
   - 下载: https://aka.ms/vs/17/release/vc_redist.x64.exe
   - 双击安装，按提示完成

2. 安装 .NET Framework 4.8
   - 下载: https://dotnet.microsoft.com/download/dotnet-framework/net48

3. 安装显卡驱动 (NVIDIA)
   - 下载最新Game Ready驱动
   - 确保CUDA 11.x+支持
```

#### 步骤2: 安装相机SDK

**海康威视MVS**:
```
安装路径: D:\MVS
1. 下载MVS客户端
2. 运行安装程序
3. 选择"完整安装"
4. 安装后重启电脑
```

**Basler Pylon**:
```
安装路径: C:\Program Files\Basler\pylon 6
1. 下载pylon Camera Software Suite
2. 运行安装程序
3. 选择Developer安装
4. 安装后重启电脑
```

#### 步骤3: 安装VisionForge Pro

```
1. 解压安装包到目标目录
   推荐: D:\VisionForge Pro

2. 运行安装脚本
   > install.bat

3. 配置环境变量
   添加到PATH:
   - D:\VisionForge Pro\bin
   - D:\VisionForge Pro\lib

4. 首次运行配置
   > VisionForge.exe --first-run
```

### 4.3 配置文件说明

**主配置文件**: `config/VisionForge.ini`

```ini
[General]
Language=zh_CN
Theme=dark
AutoSave=true
AutoSaveInterval=300

[Camera]
DefaultTimeout=3000
BufferCount=10
HeartbeatTimeout=5000

[PLC]
DefaultProtocol=ModbusTCP
ReconnectInterval=5000
MaxRetry=3

[Algorithm]
UseGPU=true
GPUDeviceIndex=0
ThreadCount=8

[Logging]
Level=INFO
MaxFileSize=10485760
MaxFileCount=10
LogPath=logs/
```

**相机配置文件**: `config/cameras.json`

```json
{
  "cameras": [
    {
      "id": "CAM_001",
      "name": "主检测相机",
      "type": "GigE",
      "ip": "192.168.1.10",
      "serialNumber": "SN123456",
      "parameters": {
        "exposureTime": 5000,
        "gain": 1.0,
        "triggerMode": "Software"
      }
    }
  ]
}
```

**PLC配置文件**: `config/plc.json`

```json
{
  "connections": [
    {
      "name": "MainPLC",
      "protocol": "ModbusTCP",
      "ipAddress": "192.168.0.1",
      "port": 502,
      "slaveId": 1,
      "timeout": 3000
    }
  ]
}
```

---

## 5. 相机调试流程

### 5.1 相机调试流程图

```
+=========================================================================+
|                          相机调试流程                                    |
+=========================================================================+
                                    |
                                    v
                        +---------------------+
                        |   1. 物理连接检查    |
                        |   - 网线/USB连接     |
                        |   - 电源指示灯      |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   2. 网络/驱动配置   |
                        |   - IP地址设置      |
                        |   - MTU/缓冲区      |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   3. 相机发现与连接  |
                        |   - 自动枚举设备     |
                        |   - 选择目标相机     |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   4. 参数配置        |
                        |   - 曝光时间        |
                        |   - 增益/白平衡     |
                        |   - ROI设置         |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   5. 图像采集测试    |
                        |   - 单帧采集        |
                        |   - 连续采集        |
                        |   - 触发采集        |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   6. 图像质量验证    |
                        |   - 亮度/对比度     |
                        |   - 噪声水平        |
                        |   - 清晰度检查      |
                        +---------------------+
                                    |
                                    v
                       +-----------------------+
                       |   7. 保存配置并验证    |
                       +-----------------------+
```

### 5.2 GenTL通用相机配置

GenTL (GenICam Transport Layer) 是通用相机接口标准，VisionForge Pro完整支持GenTL 1.5规范。

#### 5.2.1 GenTL Producer配置

**系统环境变量**:
```
GENICAM_GENTL64_PATH=C:\Program Files\Basler\pylon 6\Runtime\x64
```

**支持的Producer**:
- Basler Pylon GenTL Producer
- 海康威视 GenTL Producer
- Matrix Vision mvGenTL
- STEMMER IMAGING CVB GenTL

#### 5.2.2 相机发现

```cpp
// 代码示例：相机发现流程
1. 加载GenTL Producer库 (.cti文件)
2. 初始化GenTL库 (GCInitLib)
3. 打开Transport Layer (TLOpen)
4. 更新接口列表 (TLUpdateInterfaceList)
5. 枚举接口和设备
6. 获取设备信息 (DevGetInfo)
```

#### 5.2.3 UI操作步骤

1. **打开相机配置对话框**
   - 菜单: 设置 -> 相机配置
   - 快捷键: Ctrl+K

2. **扫描相机**
   - 点击"扫描设备"按钮
   - 等待枚举完成 (约2-5秒)

3. **选择并连接相机**
   - 从列表选择目标相机
   - 点击"连接"按钮
   - 检查连接状态指示灯

4. **配置相机参数**

| 参数 | 典型值 | 说明 |
|------|--------|------|
| 曝光时间 | 1000-10000us | 根据光照调整 |
| 增益 | 0-12dB | 越低噪声越小 |
| 触发模式 | Software/Hardware | 按需选择 |
| 像素格式 | Mono8/BayerRG8 | 灰度/彩色 |
| ROI | 全幅/自定义 | 减小可提升帧率 |

### 5.3 海康威视相机配置

#### 5.3.1 MVS客户端验证

1. 打开海康MVS客户端
2. 确认相机可被发现
3. 测试图像采集
4. 记录相机序列号

#### 5.3.2 VisionForge配置

```
1. 启用海康支持
   CMake: -DUSE_HIKVISION_MVS=ON

2. 配置SDK路径
   HIKVISION_MVS_ROOT=D:\MVS

3. 在UI中添加相机
   - 类型选择: Hikvision
   - 填入IP地址或序列号
```

### 5.4 Basler相机配置

#### 5.4.1 Pylon Viewer验证

1. 打开Basler pylon Viewer
2. 确认相机可被发现
3. 测试图像采集
4. 配置用户集 (User Set)

#### 5.4.2 VisionForge配置

```
1. 启用Basler支持
   CMake: -DUSE_BASLER_PYLON=ON

2. 配置SDK路径
   PYLON_ROOT=C:\Program Files\Basler\pylon 6

3. 在UI中添加相机
   - 类型选择: Basler
   - 填入序列号或用户定义名称
```

### 5.5 相机参数调优指南

#### 5.5.1 曝光时间设置

```
目标: 使图像亮度适中，直方图分布均匀

步骤:
1. 关闭自动曝光
2. 从较短时间开始 (如1000us)
3. 逐步增加直到图像亮度合适
4. 检查高光区域是否过曝

参考值:
- 室内标准光源: 2000-5000us
- 强光环境: 500-2000us
- 弱光环境: 5000-20000us
```

#### 5.5.2 增益设置

```
原则: 尽量使用低增益，用光源亮度补偿

设置建议:
- 优先调整光源亮度
- 增益控制在0-6dB
- 超过10dB噪声明显增加
```

#### 5.5.3 触发模式配置

| 模式 | 应用场景 | 配置要点 |
|------|----------|----------|
| 软触发 | 调试/低速检测 | 软件发送触发命令 |
| 硬触发 | 高速生产线 | 外部信号触发 |
| 编码器触发 | 连续物料检测 | 配合运动控制 |

---

## 6. 通信协议配置

### 6.1 通信协议对比

| 协议 | 应用场景 | 传输速度 | 实时性 | 复杂度 |
|------|----------|----------|--------|--------|
| Modbus TCP | 通用工业场景 | 中 | 中 | 低 |
| Modbus RTU | 串口设备 | 低 | 中 | 低 |
| OPC UA | 工业4.0/MES集成 | 高 | 中 | 高 |
| EtherCAT | 实时控制 | 极高 | 极高 | 高 |
| 三菱MC协议 | 三菱PLC | 高 | 高 | 中 |
| 基恩士PC-Link | 基恩士PLC | 高 | 高 | 中 |

### 6.2 Modbus TCP配置

#### 6.2.1 连接配置

```
参数设置:
- 协议: Modbus TCP
- IP地址: 192.168.0.1
- 端口: 502
- 站号: 1
- 超时: 3000ms
```

#### 6.2.2 寄存器映射

```
标准Modbus功能码:
- 01: 读线圈 (Coil)
- 02: 读离散输入 (Discrete Input)
- 03: 读保持寄存器 (Holding Register)
- 04: 读输入寄存器 (Input Register)
- 05: 写单个线圈
- 06: 写单个寄存器
- 0F: 写多个线圈
- 10: 写多个寄存器

典型地址分配:
+--------+----------------+------------------+
| 地址   | 用途           | 数据类型         |
+--------+----------------+------------------+
| D0     | 检测结果OK/NG  | BOOL (1=OK)      |
| D1     | X坐标偏移      | INT16 (0.01mm)   |
| D2     | Y坐标偏移      | INT16 (0.01mm)   |
| D3     | 角度偏移       | INT16 (0.01deg)  |
| D10    | 触发信号       | BOOL             |
| D11    | 就绪信号       | BOOL             |
+--------+----------------+------------------+
```

#### 6.2.3 UI操作步骤

1. 打开PLC配置对话框 (菜单: 设置 -> PLC配置)
2. 点击"添加连接"
3. 选择协议: Modbus TCP
4. 填入IP地址和端口
5. 点击"测试连接"
6. 配置数据映射
7. 保存配置

### 6.3 Modbus RTU配置

#### 6.3.1 串口参数

```
参数设置:
- 串口: COM1
- 波特率: 9600 (常用: 9600/19200/38400/115200)
- 数据位: 8
- 停止位: 1
- 校验: None (或 Even/Odd)
- 站号: 1
```

#### 6.3.2 接线说明

```
RS485接线 (两线制):
+----------+     +----------+
| 工控机   |     | PLC      |
| RS485+ --+-----+-- A+     |
| RS485- --+-----+-- B-     |
| GND -----+-----+-- GND    |
+----------+     +----------+

注意: 终端电阻120Ω，距离超过100米需要中继
```

### 6.4 OPC UA配置

#### 6.4.1 连接配置

```
OPC UA配置参数:
- Endpoint URL: opc.tcp://192.168.1.100:4840
- 安全策略: None / Basic256Sha256
- 安全模式: None / Sign / SignAndEncrypt
- 用户认证: Anonymous / Username

会话参数:
- 连接超时: 5000ms
- 会话超时: 60000ms
- 采样间隔: 100ms
- 发布间隔: 500ms
```

#### 6.4.2 节点浏览与订阅

```
节点ID格式:
- 数值型: ns=2;i=10001
- 字符串型: ns=2;s=DetectionResult

操作步骤:
1. 连接OPC UA服务器
2. 浏览节点树
3. 选择需要读写的节点
4. 配置订阅或定时读取
5. 设置数据变化回调
```

### 6.5 通信调试工具

#### 6.5.1 内置PLC监控面板

```
功能:
- 实时查看寄存器值
- 手动写入测试数据
- 通信日志记录
- 错误统计

打开方式: 菜单 -> 工具 -> PLC监控
```

#### 6.5.2 外部调试工具

| 工具 | 用途 | 下载地址 |
|------|------|----------|
| Modbus Poll | Modbus主站测试 | www.modbustools.com |
| UaExpert | OPC UA客户端 | www.unified-automation.com |
| Wireshark | 网络抓包分析 | www.wireshark.org |

---

## 7. 算法工具链使用

### 7.1 算法工具分类

```
+=========================================================================+
|                          算法工具分类                                    |
+=========================================================================+
|                                                                          |
|  +---------------------------+  +---------------------------+            |
|  |     图像预处理工具         |  |     特征检测工具          |            |
|  | +----------------------+  |  | +----------------------+  |            |
|  | | GrayTool   灰度转换  |  |  | | EdgeTool   边缘检测  |  |            |
|  | | BlurTool   模糊滤波  |  |  | | CircleTool 圆检测    |  |            |
|  | | ThresholdTool 二值化 |  |  | | LineTool   直线检测  |  |            |
|  | | MorphologyTool 形态学|  |  | | BlobTool   Blob分析  |  |            |
|  | | ColorConvertTool     |  |  | | FindEdgeTool 边缘查找|  |            |
|  | +----------------------+  |  | +----------------------+  |            |
|  +---------------------------+  +---------------------------+            |
|                                                                          |
|  +---------------------------+  +---------------------------+            |
|  |     模板匹配工具          |  |     测量分析工具          |            |
|  | +----------------------+  |  | +----------------------+  |            |
|  | | ShapeMatchTool       |  |  | | MeasureDistanceTool  |  |            |
|  | | TemplateMatchTool    |  |  | | MeasureAngleTool     |  |            |
|  | | SubPixelEdgeTool     |  |  | | MeasureAreaTool      |  |            |
|  | +----------------------+  |  | | CalcCenterTool       |  |            |
|  +---------------------------+  | | CalcOrientationTool  |  |            |
|                                 | +----------------------+  |            |
|  +---------------------------+  +---------------------------+            |
|  |     AI深度学习工具        |                                           |
|  | +----------------------+  |  +---------------------------+            |
|  | | AIDetectionTool      |  |  |     辅助工具              |            |
|  | | - YOLO目标检测       |  |  | +----------------------+  |            |
|  | | - 图像分类           |  |  | | ROITool    ROI设置   |  |            |
|  | | - 语义分割           |  |  | | SaveImageTool 保存   |  |            |
|  | +----------------------+  |  | | PLCOutputTool 输出   |  |            |
|  +---------------------------+  | | RangeJudgeTool 判定  |  |            |
|                                 | | LogicOperationTool   |  |            |
|                                 | +----------------------+  |            |
|                                 +---------------------------+            |
+=========================================================================+
```

### 7.2 工具链配置流程

```
+-------------+     +-------------+     +-------------+
|  图像采集   | --> | 图像预处理  | --> | 特征提取    |
+-------------+     +-------------+     +-------------+
                                              |
                                              v
+-------------+     +-------------+     +-------------+
|  结果输出   | <-- | 判定逻辑    | <-- | 测量分析    |
+-------------+     +-------------+     +-------------+
```

### 7.3 常用工具配置

#### 7.3.1 形状匹配工具 (ShapeMatchTool)

**功能**: 基于Halcon的高精度形状匹配

**参数配置**:

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| 最小匹配分数 | 0.7 | 0.0-1.0 | 越高越严格 |
| 匹配数量 | 1 | 1-100 | 最多返回多少结果 |
| 角度范围 | -22.5°~+22.5° | -180°~+180° | 允许的旋转范围 |
| 缩放范围 | 0.9~1.1 | 0.5~2.0 | 允许的缩放比例 |
| 最小对比度 | 30 | 1-255 | 边缘对比度阈值 |
| 贪婪度 | 0.9 | 0.0-1.0 | 搜索速度vs精度 |

**使用步骤**:

1. 创建模板
   - 选择清晰的参考图像
   - 绘制ROI包围目标
   - 设置对比度和金字塔层数
   - 保存模板文件 (.shm)

2. 配置匹配参数
   - 设置角度和缩放搜索范围
   - 调整最小匹配分数
   - 配置最大重叠度

3. 添加检验点 (可选)
   - 在模板上定义检查点
   - 设置允许偏差范围

#### 7.3.2 九点标定工具 (NinePointCalibTool)

**功能**: 像素坐标到物理坐标的转换标定

**支持模式**:
- 仿射变换 (Affine): 6参数，适用于轻微透视
- 透视变换 (Homography): 8参数，适用于透视场景

**标定步骤**:

1. 准备标定板
   - 使用精确的圆点或十字标定板
   - 确保标定板与工件平面平行

2. 采集标定点
   - 移动标定板到9个或更多位置
   - 记录每个位置的图像坐标
   - 输入对应的物理坐标

3. 执行标定计算
   - 选择标定模式
   - 点击"计算标定"
   - 检查标定误差

4. 验证标定结果
   - 使用验证点测试
   - 误差应小于0.1mm

### 7.4 工具参数调优技巧

#### 7.4.1 模板匹配调优

```
问题: 匹配失败或误匹配

解决方案:
1. 降低最小匹配分数 (0.7 -> 0.5)
2. 扩大角度搜索范围
3. 增加模板区域对比度
4. 使用更多金字塔层数
5. 启用亚像素精度

问题: 匹配速度慢

解决方案:
1. 减小搜索区域 (使用ROI)
2. 减少角度搜索范围
3. 增加角度步进
4. 使用GPU加速
5. 降低图像分辨率
```

#### 7.4.2 边缘检测调优

```
参数调整指南:

Canny边缘检测:
- 低阈值: 50-100 (弱边缘)
- 高阈值: 100-200 (强边缘)
- 高低比例建议: 2:1 到 3:1

Sobel边缘检测:
- 核大小: 3/5/7 (越大越平滑)
- 缩放因子: 根据图像调整

亚像素边缘:
- 用于高精度测量
- 精度可达0.1像素
```

---

## 8. 标定流程

### 8.1 标定类型概述

| 标定类型 | 用途 | 精度 | 复杂度 |
|----------|------|------|--------|
| 九点标定 | 平面坐标转换 | 0.1mm | 低 |
| 相机标定 | 消除镜头畸变 | 亚像素 | 中 |
| 手眼标定 | 机器人视觉引导 | 0.05mm | 高 |
| QR码标定 | 快速自动标定 | 0.2mm | 低 |

### 8.2 九点标定流程

#### 8.2.1 标定流程图

```
+=========================================================================+
|                          九点标定流程                                    |
+=========================================================================+
                                    |
                                    v
                        +---------------------+
                        |   1. 准备标定治具    |
                        |   - 精密标定板      |
                        |   - 运动平台        |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   2. 调整相机位置    |
                        |   - 视野覆盖工件    |
                        |   - 焦距调整清晰    |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   3. 采集标定点图像  |
                        |   - 至少9个点       |
                        |   - 均匀分布        |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   4. 标记图像坐标    |
                        |   - 点击特征点中心  |
                        |   - 记录像素坐标    |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   5. 输入物理坐标    |
                        |   - 从运动平台读取  |
                        |   - 或测量实际距离  |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   6. 执行标定计算    |
                        |   - 选择算法        |
                        |   - 计算转换矩阵    |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   7. 验证标定精度    |
                        |   - 测试验证点      |
                        |   - 误差分析        |
                        +---------------------+
                                    |
                                    v
                       +-----------------------+
                       |   8. 保存标定结果      |
                       +-----------------------+
```

#### 8.2.2 详细操作步骤

**步骤1: 打开九点标定对话框**
- 菜单: 工具 -> 标定 -> 九点标定
- 或在工具栏点击标定图标

**步骤2: 配置标定参数**
```
标定模式:
- Affine (仿射): 适用于正视图
- Homography (单应性): 适用于斜视图

后端选择:
- OpenCV: 通用，稳定
- Halcon: 高精度 (需Halcon许可)

点数设置: 9点 (默认) 或更多
```

**步骤3: 采集标定点**

1. 移动运动平台到第一个位置
2. 记录平台坐标 (X1, Y1)
3. 采集图像
4. 在图像上点击特征点
5. 输入物理坐标
6. 重复上述步骤采集所有点

**步骤4: 标定点分布建议**

```
+---+---+---+
| 1 | 2 | 3 |
+---+---+---+
| 4 | 5 | 6 |
+---+---+---+
| 7 | 8 | 9 |
+---+---+---+

说明:
- 点均匀分布在视野范围内
- 覆盖检测区域的边缘和中心
- 间距建议10-50mm
```

**步骤5: 执行标定**
- 点击"计算标定"按钮
- 查看标定误差
- 如误差过大，检查数据并重新标定

**步骤6: 验证标定**
- 移动到标定点以外的位置
- 采集图像，检测特征点
- 比较转换坐标与实际坐标
- 误差应小于要求精度

### 8.3 相机内参标定

#### 8.3.1 标定板要求

```
推荐标定板:
- 棋盘格: 9x6 或 10x7 角点
- 圆点阵列: 精度更高
- 格子大小: 10-30mm

注意事项:
- 标定板平整度 < 0.1mm
- 打印质量高，边缘清晰
- 固定在刚性板上
```

#### 8.3.2 标定步骤

1. **采集标定图像**
   - 至少20张不同角度图像
   - 标定板占画面30-80%
   - 覆盖各种倾斜角度

2. **角点检测**
   - 自动检测棋盘格角点
   - 确保所有角点被正确识别

3. **计算内参**
   - 相机矩阵 (焦距、主点)
   - 畸变系数 (径向、切向)

4. **验证结果**
   - 重投影误差 < 0.5像素
   - 视觉检查畸变校正效果

### 8.4 QR码自动标定

#### 8.4.1 功能说明

QR码标定利用二维码的精确角点实现快速自动标定。

**优势**:
- 全自动角点检测
- 可解码获取物理尺寸信息
- 一次采集多个标定点

#### 8.4.2 使用步骤

1. **准备标定板**
   - 打印多个QR码阵列
   - 编码内容包含物理坐标
   - 确保QR码清晰可读

2. **采集图像**
   - 一次采集包含多个QR码的图像
   - 确保所有码可识别

3. **自动标定**
   - 自动检测QR码位置和角点
   - 解码获取物理坐标
   - 计算标定参数

---

## 9. 故障排查指南

### 9.1 故障排查流程图

```
+=========================================================================+
|                          故障排查流程                                    |
+=========================================================================+
                                    |
                                    v
                        +---------------------+
                        |   1. 确认故障现象    |
                        |   - 记录错误信息    |
                        |   - 复现问题步骤    |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   2. 分类故障类型    |
                        +---------------------+
                                    |
            +-------------------+---+---+-------------------+
            |                   |       |                   |
            v                   v       v                   v
    +---------------+   +---------------+   +---------------+
    | 硬件故障      |   | 软件故障      |   | 配置问题      |
    +---------------+   +---------------+   +---------------+
            |                   |                   |
            v                   v                   v
    +---------------+   +---------------+   +---------------+
    | 检查物理连接  |   | 查看日志      |   | 检查配置文件  |
    | 测试设备状态  |   | 分析异常栈    |   | 验证参数设置  |
    +---------------+   +---------------+   +---------------+
            |                   |                   |
            +-------------------+---+---+-------------------+
                                    |
                                    v
                        +---------------------+
                        |   3. 执行修复方案    |
                        +---------------------+
                                    |
                                    v
                        +---------------------+
                        |   4. 验证修复效果    |
                        +---------------------+
                                    |
                        +-----------+-----------+
                        |                       |
                  修复成功                  修复失败
                        |                       |
                        v                       v
               +---------------+       +---------------+
               | 记录解决方案  |       | 升级问题      |
               | 更新知识库    |       | 联系技术支持  |
               +---------------+       +---------------+
```

### 9.2 相机故障排查

#### 9.2.1 相机无法发现

**检查步骤**:

```
1. 物理连接检查
   [ ] 网线/USB线连接牢固
   [ ] 相机电源指示灯亮起
   [ ] 网卡链路指示灯正常

2. 网络配置检查 (GigE相机)
   [ ] 工控机IP与相机同网段
   [ ] 防火墙已关闭或添加例外
   [ ] 网卡驱动正常

3. 驱动/SDK检查
   [ ] 相机SDK已正确安装
   [ ] 环境变量已配置
   [ ] 用第三方工具能发现相机

4. 其他检查
   [ ] 相机未被其他程序占用
   [ ] 重启相机和工控机
```

#### 9.2.2 图像采集失败

**常见原因与解决方案**:

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 超时错误 | 曝光时间过长 | 减少曝光时间 |
| 缓冲区溢出 | 传输带宽不足 | 增大MTU，启用巨型帧 |
| 图像全黑 | 镜头盖未取/光源未开 | 检查光路 |
| 图像过曝 | 曝光时间过长 | 减少曝光或降低光源 |
| 图像模糊 | 焦距/光圈问题 | 调整镜头 |

#### 9.2.3 帧率低

```
排查步骤:
1. 检查曝光时间 (帧率 ≈ 1/曝光时间)
2. 检查网络带宽利用率
3. 减小ROI区域
4. 检查CPU/GPU占用
5. 关闭不必要的图像处理
```

### 9.3 通信故障排查

#### 9.3.1 Modbus通信失败

**检查步骤**:

```
1. 物理层检查
   [ ] 网线/串口线连接正常
   [ ] PLC电源正常
   [ ] 终端电阻正确 (RTU)

2. 网络层检查 (TCP)
   [ ] ping PLC IP地址
   [ ] 检查端口502是否开放
   [ ] 防火墙规则

3. 协议层检查
   [ ] 站号设置正确
   [ ] 寄存器地址有效
   [ ] 数据格式匹配

4. 使用Modbus测试工具验证
```

#### 9.3.2 OPC UA连接失败

**检查步骤**:

```
1. 网络连通性
   [ ] ping服务器IP
   [ ] 端口可访问 (默认4840)

2. 安全配置
   [ ] 安全策略匹配
   [ ] 证书有效
   [ ] 用户名密码正确

3. 使用UaExpert测试连接
```

### 9.4 算法故障排查

#### 9.4.1 模板匹配失败

**排查清单**:

```
1. 模板问题
   [ ] 模板文件存在且有效
   [ ] 模板对比度足够
   [ ] 模板包含足够特征

2. 搜索参数
   [ ] 匹配分数阈值是否过高
   [ ] 角度/缩放范围是否足够
   [ ] 搜索区域是否正确

3. 图像质量
   [ ] 光照是否稳定
   [ ] 对比度是否足够
   [ ] 图像是否清晰

4. 调试方法
   [ ] 降低匹配阈值查看候选结果
   [ ] 可视化匹配轮廓
   [ ] 对比模板图与检测图
```

#### 9.4.2 标定精度不足

**改进措施**:

```
1. 增加标定点数量 (9点 -> 16点或更多)
2. 改善标定点分布，覆盖整个视野
3. 提高图像坐标定位精度
4. 使用更精确的物理测量设备
5. 检查标定板平面度
6. 减少环境振动
```

### 9.5 日志分析

#### 9.5.1 日志位置

```
日志目录: [安装目录]/logs/
日志文件: VisionForge_YYYYMMDD.log

日志级别:
- DEBUG: 详细调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息
- CRITICAL: 严重错误
```

#### 9.5.2 常见错误日志解读

```
[ERROR] 相机连接超时
原因: 网络问题或相机无响应
解决: 检查网络连接，重启相机

[ERROR] Modbus通信错误: 超时
原因: PLC无响应或网络延迟
解决: 检查PLC状态，增加超时时间

[ERROR] 模板加载失败
原因: 模板文件损坏或路径错误
解决: 重新创建模板或检查路径

[WARNING] GPU加速不可用
原因: CUDA驱动问题或显卡不支持
解决: 更新显卡驱动，检查CUDA配置
```

---

## 10. 常见问题与解决方案

### 10.1 安装类问题

#### Q1: 软件启动时提示缺少DLL

**症状**: 提示"找不到xxx.dll"

**解决方案**:
1. 安装Visual C++ Redistributable 2022
2. 检查Qt运行时DLL是否在PATH中
3. 使用Dependency Walker检查依赖

#### Q2: 提示Qt版本不兼容

**症状**: 提示Qt版本错误

**解决方案**:
1. 确认安装Qt 6.9.3
2. 检查PATH中Qt路径正确
3. 重新编译程序

### 10.2 相机类问题

#### Q3: GigE相机发现但无法采集图像

**症状**: 相机列表可见，但采集超时

**解决方案**:
1. 设置网卡MTU为9000
2. 增大接收缓冲区
3. 关闭节能模式
4. 检查IP地址设置

#### Q4: USB3相机时断时续

**症状**: 相机频繁断开重连

**解决方案**:
1. 使用原装USB3线缆
2. 直连主板USB口，不用集线器
3. 检查USB控制器驱动
4. 禁用USB节能

### 10.3 通信类问题

#### Q5: Modbus通信延迟高

**症状**: 读写响应慢

**解决方案**:
1. 减少单次读取数量
2. 使用批量读写
3. 检查网络拥塞
4. 调整PLC扫描周期

#### Q6: OPC UA频繁断开

**症状**: 连接不稳定

**解决方案**:
1. 增加会话超时时间
2. 启用自动重连
3. 检查网络稳定性
4. 调整发布间隔

### 10.4 算法类问题

#### Q7: 形状匹配速度慢

**症状**: 匹配时间超过100ms

**解决方案**:
1. 减小搜索角度范围
2. 使用更大的角度步进
3. 减小搜索区域ROI
4. 启用GPU加速
5. 降低图像分辨率

#### Q8: 标定后坐标偏差大

**症状**: 转换坐标误差超过1mm

**解决方案**:
1. 增加标定点数量
2. 检查图像坐标点击精度
3. 验证物理坐标测量精度
4. 使用更高精度的标定模式
5. 检查相机是否移动

### 10.5 性能类问题

#### Q9: 内存持续增长

**症状**: 长时间运行内存占用越来越高

**解决方案**:
1. 检查图像缓存设置
2. 减少历史记录保留数量
3. 定期重启程序
4. 检查是否有内存泄漏

#### Q10: CPU占用过高

**症状**: CPU持续100%

**解决方案**:
1. 减少并行处理线程数
2. 降低处理帧率
3. 优化算法参数
4. 启用GPU加速分担负载

---

## 附录

### A. 快捷键列表

| 快捷键 | 功能 |
|--------|------|
| Ctrl+N | 新建项目 |
| Ctrl+O | 打开项目 |
| Ctrl+S | 保存项目 |
| Ctrl+K | 相机配置 |
| Ctrl+P | PLC配置 |
| F5 | 运行检测 |
| F6 | 单步运行 |
| F7 | 停止运行 |
| Ctrl+Z | 撤销 |
| Ctrl+Y | 重做 |
| Ctrl++ | 放大图像 |
| Ctrl+- | 缩小图像 |
| Ctrl+0 | 适应窗口 |

### B. 错误代码表

| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| E1001 | 相机连接失败 | 检查网络/USB连接 |
| E1002 | 相机采集超时 | 调整曝光时间 |
| E1003 | 图像格式不支持 | 更改相机像素格式 |
| E2001 | PLC连接失败 | 检查网络/串口配置 |
| E2002 | 寄存器读取失败 | 验证地址范围 |
| E2003 | 寄存器写入失败 | 检查写权限 |
| E3001 | 模板加载失败 | 检查文件路径 |
| E3002 | 匹配失败 | 调整匹配参数 |
| E3003 | 标定数据无效 | 重新标定 |

### C. 技术支持联系方式

| 类型 | 联系方式 |
|------|----------|
| 技术热线 | 400-xxx-xxxx |
| 电子邮件 | support@visionforge.com |
| 在线文档 | https://docs.visionforge.com |
| 远程支持 | 预约后提供 |

### D. 版本历史

| 版本 | 日期 | 主要更新 |
|------|------|----------|
| 1.0.0 | 2025-10 | 初始版本 |
| 1.1.0 | 2025-11 | 增加AI检测模块 |
| 1.2.0 | 2025-12 | GenTL相机支持、OPC UA增强 |

---

**文档结束**

*本文档最后更新: 2025年12月22日*
*VisionForge Pro 版本: 1.2.0*

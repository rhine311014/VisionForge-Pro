name: ðŸ§ª VisionForge Pro - è‡ªåŠ¨åŒ–æµ‹è¯•

on:
  push:
    branches: [ master, develop, feature/* ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  BUILD_TYPE: Release
  VCPKG_DEFAULT_TRIPLET: x64-windows

jobs:
  # ==================== Windowsæž„å»ºå’Œæµ‹è¯• ====================
  test-windows:
    name: ðŸªŸ Windowsæµ‹è¯•
    runs-on: windows-latest

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ è®¾ç½®MSVCçŽ¯å¢ƒ
      uses: microsoft/setup-msbuild@v1.1

    - name: ðŸ“¦ ç¼“å­˜vcpkgä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ${{ github.workspace }}/vcpkg
          ${{ github.workspace }}/build/vcpkg_installed
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: ðŸ”¨ å®‰è£…ä¾èµ– (vcpkg)
      shell: powershell
      run: |
        if (-Not (Test-Path vcpkg)) {
          git clone https://github.com/Microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat
        }
        .\vcpkg\vcpkg install opencv4[core,contrib]:x64-windows qt6[core,widgets]:x64-windows

    - name: ðŸ“¦ ç¼“å­˜Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        cached: true

    - name: ðŸ—ï¸ é…ç½®CMake
      shell: powershell
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DUSE_GTEST=ON `
          -DENABLE_COVERAGE=OFF

    - name: ðŸ”¨ ç¼–è¯‘é¡¹ç›®
      shell: powershell
      run: cmake --build build --config ${{ env.BUILD_TYPE }} -j 4

    - name: ðŸ§ª è¿è¡Œæµ‹è¯• - ImageData
      shell: powershell
      working-directory: ${{ github.workspace }}/build/bin/${{ env.BUILD_TYPE }}
      run: |
        echo "=== è¿è¡Œ ImageData æµ‹è¯• ==="
        .\test_ImageData_gtest.exe --gtest_output=xml:test_results_imagedata.xml

    - name: ðŸ§ª è¿è¡Œæµ‹è¯• - BasicImageProcessing
      shell: powershell
      working-directory: ${{ github.workspace }}/build/bin/${{ env.BUILD_TYPE }}
      run: |
        echo "=== è¿è¡Œ BasicImageProcessing æµ‹è¯• ==="
        .\test_BasicImageProcessing_gtest.exe --gtest_output=xml:test_results_basic.xml

    - name: ðŸ§ª è¿è¡Œæµ‹è¯• - EdgeAndMorphology
      shell: powershell
      working-directory: ${{ github.workspace }}/build/bin/${{ env.BUILD_TYPE }}
      run: |
        echo "=== è¿è¡Œ EdgeAndMorphology æµ‹è¯• ==="
        .\test_EdgeAndMorphology_gtest.exe --gtest_output=xml:test_results_edge.xml

    - name: ðŸ§ª è¿è¡Œæµ‹è¯• - ShapeDetection
      shell: powershell
      working-directory: ${{ github.workspace }}/build/bin/${{ env.BUILD_TYPE }}
      run: |
        echo "=== è¿è¡Œ ShapeDetection æµ‹è¯• ==="
        .\test_ShapeDetection_gtest.exe --gtest_output=xml:test_results_shape.xml

    - name: ðŸ§ª è¿è¡Œæµ‹è¯• - Measurement
      shell: powershell
      working-directory: ${{ github.workspace }}/build/bin/${{ env.BUILD_TYPE }}
      run: |
        echo "=== è¿è¡Œ Measurement æµ‹è¯• ==="
        .\test_Measurement_gtest.exe --gtest_output=xml:test_results_measure.xml

    - name: ðŸ“Š å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
      uses: EnricoMi/publish-unit-test-result-action/composite@v2
      if: always()
      with:
        files: |
          build/bin/${{ env.BUILD_TYPE }}/test_results_*.xml
        check_name: 'ðŸ§ª Windowsæµ‹è¯•ç»“æžœ'
        comment_title: 'ðŸ§ª Windowså•å…ƒæµ‹è¯•æŠ¥å‘Š'

    - name: ðŸ“¦ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-windows
        path: build/bin/${{ env.BUILD_TYPE }}/test_results_*.xml
        retention-days: 30

  # ==================== Linuxæž„å»ºå’Œæµ‹è¯•ï¼ˆå¸¦ä»£ç è¦†ç›–çŽ‡ï¼‰====================
  test-linux-coverage:
    name: ðŸ§ Linuxæµ‹è¯• + ä»£ç è¦†ç›–çŽ‡
    runs-on: ubuntu-22.04

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          qt6-base-dev \
          qt6-tools-dev \
          libopencv-dev \
          lcov \
          gcovr

    - name: ðŸ—ï¸ é…ç½®CMakeï¼ˆå¯ç”¨è¦†ç›–çŽ‡ï¼‰
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DUSE_GTEST=ON \
          -DENABLE_COVERAGE=ON \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

    - name: ðŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: cmake --build build -j $(nproc)

    - name: ðŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•
      working-directory: ${{ github.workspace }}/build/bin
      run: |
        for test in test_*_gtest; do
          echo "=== è¿è¡Œ $test ==="
          ./$test --gtest_output=xml:${test}_results.xml
        done

    - name: ðŸ“Š ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Šï¼ˆlcovï¼‰
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/test/*' '*/build/*' --output-file coverage_filtered.info
        lcov --list coverage_filtered.info

    - name: ðŸ“Š ç”ŸæˆHTMLè¦†ç›–çŽ‡æŠ¥å‘Š
      run: |
        genhtml coverage_filtered.info --output-directory coverage_html

    - name: ðŸ“¤ ä¸Šä¼ è¦†ç›–çŽ‡åˆ°Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage_filtered.info
        flags: unittests
        name: visionforge-coverage
        fail_ci_if_error: false

    - name: ðŸ“¦ ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Šï¼ˆArtifactsï¼‰
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage_html/
        retention-days: 30

    - name: ðŸ“Š å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: build/bin/*_results.xml
        check_name: 'ðŸ§ª Linuxæµ‹è¯•ç»“æžœ'
        comment_title: 'ðŸ§ª Linuxå•å…ƒæµ‹è¯•æŠ¥å‘Š + ä»£ç è¦†ç›–çŽ‡'

  # ==================== æ€§èƒ½åŸºå‡†æµ‹è¯• ====================
  benchmark-tests:
    name: âš¡ æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ”§ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake qt6-base-dev libopencv-dev

    - name: ðŸ—ï¸ é…ç½®CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DUSE_GTEST=ON

    - name: ðŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: cmake --build build -j $(nproc)

    - name: âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆç¦ç”¨çš„æµ‹è¯•ï¼‰
      working-directory: ${{ github.workspace }}/build/bin
      run: |
        for test in test_*_gtest; do
          echo "=== è¿è¡Œ $test æ€§èƒ½æµ‹è¯• ==="
          ./$test --gtest_also_run_disabled_tests --gtest_filter="*DISABLED_Performance*" || true
        done

  # ==================== æµ‹è¯•æ‘˜è¦ ====================
  test-summary:
    name: ðŸ“‹ æµ‹è¯•æ‘˜è¦
    runs-on: ubuntu-latest
    needs: [test-windows, test-linux-coverage]
    if: always()

    steps:
    - name: ðŸ“Š ç”Ÿæˆæ‘˜è¦
      run: |
        echo "## ðŸŽ‰ VisionForge Pro æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æµ‹è¯•å¥—ä»¶çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸªŸ Windows | ${{ needs.test-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ Linux + Coverage | ${{ needs.test-linux-coverage.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æµ‹è¯•è¦†ç›–" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 5ä¸ªæµ‹è¯•å¥—ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 119ä¸ªæµ‹è¯•ç”¨ä¾‹" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… 12ä¸ªæ ¸å¿ƒå·¥å…·ç±»" >> $GITHUB_STEP_SUMMARY
